# /data/mlops/DRST-SoftwarizedNetworks/docker/dockerfile
# syntax=docker/dockerfile:1.6

# 0) deps — only responsible for installing dependencies
FROM python:3.10-slim AS deps
ENV PIP_DISABLE_PIP_VERSION_CHECK=1 PIP_NO_CACHE_DIR=1 \
    PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1
# Build-time dependencies stay only in the build layer, not in the final image
RUN apt-get update && apt-get install -y --no-install-recommends \
      gcc g++ curl ca-certificates git \
    && rm -rf /var/lib/apt/lists/*

# Independent venv for easy copying
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

WORKDIR /opt/src
COPY requirements.txt .
# Use BuildKit pip cache
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --upgrade pip && pip install -r requirements.txt

# 1) base — runtime base layer (reuse venv, copy common code only)
FROM python:3.10-slim AS base
ENV PATH="/opt/venv/bin:$PATH" PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1
# Copy venv only, avoid bringing build tools
COPY --from=deps /opt/venv /opt/venv
WORKDIR /app

# Shared code (as stable as possible to reduce rebuilds)
COPY drst_common ./drst_common
COPY requirements.txt ./requirements.txt

# 2) component images — copy only their own code
# 2.1 offline
FROM base AS offline
# Copy only code needed for offline
COPY drst_inference/offline ./drst_inference/offline
COPY drst_inference/offline/__init__.py ./drst_inference/offline/__init__.py
# During training datasets may be needed locally (currently you mostly use MinIO, can leave empty)
COPY datasets ./datasets
CMD ["bash","-lc","python -V && echo offline image ready"]

# 2.2 monitor
FROM base AS monitor
COPY drst_drift ./drst_drift
CMD ["bash","-lc","python -V && echo monitor image ready"]

# 2.3 producer
FROM base AS producer
COPY drst_inference/online ./drst_inference/online
CMD ["bash","-lc","python -V && echo producer image ready"]

# 2.4 infer
FROM base AS infer
COPY drst_inference/online ./drst_inference/online
CMD ["bash","-lc","python -V && echo infer image ready"]

# 2.5 plot
FROM base AS plot
COPY drst_inference/plotting ./drst_inference/plotting
CMD ["bash","-lc","python -V && echo plot image ready"]

# /data/mlops/DRST-SoftwarizedNetworks/docker/dockerfile
# syntax=docker/dockerfile:1.6

FROM python:3.10-slim AS deps
ENV PIP_DISABLE_PIP_VERSION_CHECK=1 PIP_NO_CACHE_DIR=1 \
    PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1
RUN apt-get update && apt-get install -y --no-install-recommends \
      gcc g++ curl ca-certificates git \
    && rm -rf /var/lib/apt/lists/*

RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

WORKDIR /opt/src
COPY requirements.txt ./
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --upgrade pip && pip install -r requirements.txt

# ---------------------------- base ----------------------------
FROM python:3.10-slim AS base
ENV PATH="/opt/venv/bin:$PATH" PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1
ENV APP_DIR=/app PYTHONPATH=/app
COPY --from=deps /opt/venv /opt/venv
WORKDIR /app
COPY drst_common ./drst_common
COPY requirements.txt ./requirements.txt

# -------------------------- offline ---------------------------
FROM base AS offline
COPY drst_inference/offline ./drst_inference/offline
COPY datasets ./datasets
CMD ["bash","-lc","python -V && echo offline image ready"]

# -------------------------- monitor ---------------------------
FROM base AS monitor
COPY drst_drift ./drst_drift
CMD ["bash","-lc","python -V && echo monitor image ready"]

# -------------------------- producer --------------------------
FROM base AS producer
COPY drst_inference/online ./drst_inference/online
CMD ["bash","-lc","python -V && echo producer image ready"]

# --------------------------- infer ----------------------------
FROM base AS infer
COPY drst_inference/online ./drst_inference/online
COPY drst_inference/offline ./drst_inference/offline
CMD ["bash","-lc","python -V && echo infer image ready"]

# ---------------------------- plot ----------------------------
FROM base AS plot
COPY drst_inference/plotting ./drst_inference/plotting
# 确保路径与运行时一致（experiments/kubeflow/summarize_resources.py）
RUN mkdir -p experiments/kubeflow
COPY experiments/kubeflow/summarize_resources.py ./experiments/kubeflow/summarize_resources.py
# 让 plot 节点也能生成 forecasting 报告
COPY drst_forecasting ./drst_forecasting
CMD ["bash","-lc","python -V && echo plot image ready"]

# -------------------------- retrain ---------------------------
FROM base AS retrain
COPY drst_drift ./drst_drift
COPY drst_inference/offline ./drst_inference/offline
CMD ["bash","-lc","python -V && echo retrain image ready"]

# ------------------------- forecast ---------------------------
# 通用 forecasting 镜像（训练/解释/serve 都用它）
FROM base AS forecast
COPY drst_forecasting ./drst_forecasting
CMD ["bash","-lc","python -V && echo forecast image ready"]
